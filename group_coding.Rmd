---
title: "group_project"
author: "Seibi Kobara"
date: "3/19/2022"
output: html_document
---

```{r message=FALSE}
options(scipen = 999)
library(EpiModel)
library(tidyverse)
library(magrittr)
library(gplots)
opts_chunk$set(tidy.opts=list(width.cutoff=50),tidy=TRUE)
```

# parameter

* omega: vaccine coverage
* psi  : vaccine efficacy
* gamma: infectious period
* rho  : immunity


# age-contact matrix M
```{r}
contact=read.csv("contact_matrix.csv")
M=contact[,-c(1)]
names(M)=c("0-5 months","6-12 months", 
           "1-4 yrs","5-19 yrs","20-39 yrs","40-59 yrs","60+ yrs")
rownames(M)=c("0-5 months","6-12 months", 
              "1-4 yrs","5-19 yrs","20-39 yrs","40-59 yrs","60+ yrs")
```

# initial setting
```{r}
omega_=1  # 100% coverage
psi_=1    # 100% efficacy
R0=10
gamma=1/14
```

# beta (coefficient of effective contact)
```{r}
eiganvalue=5.822557704881415
# beta for non vaccinated
beta_ = R0 * gamma/eiganvalue
# beta for vaccinated
beta.v_ = R0 *(1-psi_)* gamma/eiganvalue

beta_
beta.v_
```

# model
```{r}
# compartment
# v06 : vaccinated 0-6months
# iv06: infection from vaccinated group
# s06 : susceptible (unvaccinated)
# i06 : infection from unvaccinated group
# r06 : recovered from infection

# age stages
# 0-5 months : 06
# 6-12 months: 1
# 1-4 years  : 5
# 5-19 years : 10
# 20-39 years: 30
# 40-59 years: 40
# 60 years + : 60

RSV = function(t,t0,params){
    with(as.list(c(t0,params)),{
        # total population
        num=num.v06 + num.s06 + num.iv06 + num.i06 + num.r06 +
            num.v1  + num.s1 +  num.iv1 +  num.i1 +  num.r1  + 
                      num.s5 +  num.iv5 +  num.i5 +  num.r5  +
                      num.s10 +  num.iv10 +  num.i10 +  num.r10  +
                      num.s30 +  num.iv30 +  num.i30 +  num.r30  +
                      num.s40 +  num.iv40 +  num.i40 +  num.r40  +
                      num.s60 +  num.iv60 +  num.i60 +  num.r60
        
        # differential equations
        # age 0-5months
        force_inf_v06 =      beta.v/num *(M[1,1]*(num.i06 + num.iv06) + 
                                          M[1,2]*(num.i1  + num.iv1)  +  
                                          M[1,3]*(num.i5  + num.iv5) + 
                                          M[1,4]*(num.i10 + num.iv10)+
                                          M[1,5]*(num.i30 + num.iv30)+
                                          M[1,6]*(num.i40 + num.iv40)+
                                          M[1,7]*(num.i60 + num.iv60))
        force_inf_06  =      beta  /num *(M[1,1]*(num.i06 + num.iv06) + 
                                          M[1,2]*(num.i1  + num.iv1)  +  
                                          M[1,3]*(num.i5  + num.iv5) + 
                                          M[1,4]*(num.i10 + num.iv10)+
                                          M[1,5]*(num.i30 + num.iv30)+
                                          M[1,6]*(num.i40 + num.iv40)+
                                          M[1,7]*(num.i60 + num.iv60))
        
        dV06  = num*mu*omega - force_inf_v06*num.v06 - age06*num.v06 - death06*num.v06
        dIv06 = force_inf_v06*num.v06 -gamma*num.iv06 - age06*num.iv06 - death06*num.iv06
        dS06  = num*mu*(1-omega) - force_inf_06*num.s06 - age06*num.s06 - death06*num.s06 + rho*num.r06
        dI06  = force_inf_06*num.s06 -gamma*num.i06 - age06*num.i06 - death06*num.i06
        dR06  = gamma*num.iv06 + gamma*num.i06 - rho*num.r06 - age06*num.r06 - death06*num.r06
        
        # age 6-12 months
        force_inf_v1 =      beta.v/num * (M[2,1]*(num.i06 + num.iv06) + 
                                          M[2,2]*(num.i1  + num.iv1)  +  
                                          M[2,3]*(num.i5  + num.iv5) + 
                                          M[2,4]*(num.i10 + num.iv10)+
                                          M[2,5]*(num.i30 + num.iv30)+
                                          M[2,6]*(num.i40 + num.iv40)+
                                          M[2,7]*(num.i60 + num.iv60))
        force_inf_1  =      beta  /num  *(M[2,1]*(num.i06 + num.iv06) + 
                                          M[2,2]*(num.i1  + num.iv1)  +  
                                          M[2,3]*(num.i5  + num.iv5) + 
                                          M[2,4]*(num.i10 + num.iv10)+
                                          M[2,5]*(num.i30 + num.iv30)+
                                          M[2,6]*(num.i40 + num.iv40)+
                                          M[2,7]*(num.i60 + num.iv60))
        
        dV1  = age06*num.v06 - force_inf_v1*num.v1 - age1*num.v1 - death1*num.v1
        dIv1 = force_inf_v1*num.v1 + age06*num.iv06 -gamma*num.iv1 - age1*num.iv1 - death1*num.iv1
        dS1  = age06*num.s06 + rho*num.r1 - force_inf_1*num.s1 - age1*num.s1 - death1*num.s1 
        dI1  = force_inf_1*num.s1 + age06*num.i06 -gamma*num.i1 - age1*num.i1 - death1*num.i1
        dR1  = gamma*num.iv1 + gamma*num.i1 + age06*num.r06 - rho*num.r1 - age1*num.r1 - death1*num.r1
        
        # age 1-4 years
        force_inf_5  =      beta  /num  *(M[3,1]*(num.i06 + num.iv06) + 
                                          M[3,2]*(num.i1  + num.iv1)  +  
                                          M[3,3]*(num.i5  + num.iv5) + 
                                          M[3,4]*(num.i10 + num.iv10)+
                                          M[3,5]*(num.i30 + num.iv30)+
                                          M[3,6]*(num.i40 + num.iv40)+
                                          M[3,7]*(num.i60 + num.iv60))
        
        dIv5 = age1*num.iv1 -gamma*num.iv5 - age5*num.iv5 - death5*num.iv5
        dS5  = age1*num.v1 + age1*num.s1 + rho*num.r5 - force_inf_5*num.s5 - age5*num.s5 - death5*num.s5 
        dI5  = force_inf_5*num.s5 + age1*num.i1 -gamma*num.i5 - age5*num.i5 - death5*num.i5
        dR5  = gamma*num.iv5 + gamma*num.i5+ age1*num.r1 - rho*num.r1 - age5*num.r5 - death5*num.r5
        
        # age 5-19 years
        force_inf_10  =      beta  /num *(M[4,1]*(num.i06 + num.iv06) + 
                                          M[4,2]*(num.i1  + num.iv1)  +  
                                          M[4,3]*(num.i5  + num.iv5) + 
                                          M[4,4]*(num.i10 + num.iv10)+
                                          M[4,5]*(num.i30 + num.iv30)+
                                          M[4,6]*(num.i40 + num.iv40)+
                                          M[4,7]*(num.i60 + num.iv60))
        
        dIv10 = age5*num.iv5 -gamma*num.iv10 - age10*num.iv10 - death10*num.iv10
        dS10  = age5*num.s5 + rho*num.r10 - force_inf_10*num.s10 - age10*num.s10 - death10*num.s10 
        dI10  = force_inf_10*num.s10 + age5*num.i5 -gamma*num.i10 - age10*num.i10 - death10*num.i10
        dR10  = gamma*num.iv10 + gamma*num.i10 + age5*num.r5 - rho*num.r10 - age10*num.r10 - death10*num.r10
        
        # age 20-39 years
        force_inf_30  =      beta  /num *(M[5,1]*(num.i06 + num.iv06) + 
                                          M[5,2]*(num.i1  + num.iv1)  +  
                                          M[5,3]*(num.i5  + num.iv5) + 
                                          M[5,4]*(num.i10 + num.iv10)+
                                          M[5,5]*(num.i30 + num.iv30)+
                                          M[5,6]*(num.i40 + num.iv40)+
                                          M[5,7]*(num.i60 + num.iv60))
        
        dIv30 = age10*num.iv10 -gamma*num.iv30 - age30*num.iv30 - death30*num.iv30
        dS30  = age10*num.s10 + rho*num.r30 - force_inf_30*num.s30 - age30*num.s30 - death30*num.s30 
        dI30  = force_inf_30*num.s30 + age10*num.i10 -gamma*num.i30 - age30*num.i30 - death30*num.i30
        dR30  = gamma*num.iv30 + gamma*num.i30 + age10*num.r10 - rho*num.r30 - age30*num.r30 - death30*num.r30
        
        # age 40-59 years
        force_inf_40  =      beta  /num *(M[6,1]*(num.i06 + num.iv06) + 
                                          M[6,2]*(num.i1  + num.iv1)  +  
                                          M[6,3]*(num.i5  + num.iv5) + 
                                          M[6,4]*(num.i10 + num.iv10)+
                                          M[6,5]*(num.i30 + num.iv30)+
                                          M[6,6]*(num.i40 + num.iv40)+
                                          M[6,7]*(num.i60 + num.iv60))
        
        dIv40 = age30*num.iv30 -gamma*num.iv40 - age40*num.iv40 - death40*num.iv40
        dS40  = age30*num.s30 + rho*num.r40 - force_inf_40*num.s40 - age40*num.s40 - death40*num.s40 
        dI40  = force_inf_40*num.s40 + age30*num.i30 -gamma*num.i40 - age40*num.i40 - death40*num.i40
        dR40  = gamma*num.iv40 + gamma*num.i40 + age30*num.r30- rho*num.r40 - age40*num.r40 - death40*num.r40
        
        # age 60 + years
        force_inf_60  =      beta  /num *(M[7,1]*(num.i06 + num.iv06) + 
                                          M[7,2]*(num.i1  + num.iv1)  +  
                                          M[7,3]*(num.i5  + num.iv5) + 
                                          M[7,4]*(num.i10 + num.iv10)+
                                          M[7,5]*(num.i30 + num.iv30)+
                                          M[7,6]*(num.i40 + num.iv40)+
                                          M[7,7]*(num.i60 + num.iv60))
        
        dIv60 = age40*num.iv40 -gamma*num.iv60 - death60*num.iv60
        dS60  = age40*num.s40 + rho*num.r60 - force_inf_60*num.s60 - death60*num.s60 
        dI60  = force_inf_60*num.s60 + age40*num.i40 -gamma*num.i60 - death60*num.i60
        dR60  = gamma*num.iv60 + gamma*num.i60 + age40*num.r40- rho*num.r60 - death60*num.r60
        
        # output
        list(c(
            # compartment
            dV06,
            forcev06=force_inf_v06,
            dIv06,
            dS06,
            dI06,
            dR06,
            
            dV1,
            dIv1,
            dS1,
            dI1,
            dR1,
            
            dS5,
            dIv5,
            dI5,
            dR5,
            
            dS10,
            dIv10,
            dI10,
            dR10,
            
            dS30,
            dIv30,
            dI30,
            dR30,
            
            dS40,
            dIv40,
            dI40,
            dR40,
            
            dS60,
            dIv60,
            dI60,
            dR60,
            
            # incidence
            incidence.06_vac  = force_inf_v06*num.v06,
            incidence.06      = force_inf_06*num.s06,
            
            incidence.1_vac  = force_inf_v1*num.v1,
            incidence.1      = force_inf_1*num.s1,
            
            incidence.5      = force_inf_5*num.s5,
            
            incidence.10      = force_inf_10*num.s10,
            
            incidence.30      = force_inf_30*num.s30,
            
            incidence.40      = force_inf_40*num.s40,
            
            incidence.60      = force_inf_60*num.s60
            ))
    })
}
```

```{r}
params=param.dcm(beta=beta_, 
                 beta.v=beta.v_,
                 age06=1/(365*0.5),
                 age1 =1/(365*0.5),
                 age5=1/(365*4),
                 age10 =1/(365*25),
                 age30 =1/(365*20),
                 age40 =1/(365*20),
                 
                 # because we assume the natural death rate burden starts when entering the compartment, we need to run this model for at least 75 years to obtain reasonably distributed samples... 
                 # actual death is more higher, by disease, accident
                 death06= 1/365,    # natural death:  death06=1/(365*75),   
                 death1= 1/365,             #                       1/(365*74.5),
                 death5= 1/365,           #                       1/(365*74),
                 death10=1/365,           #                       1/(365*70),                    
                 death30= 1/365,          #                       1/(365*55),
                 death40= 2/365,          #                       1/(365*35),
                 death60=  2/365,         #                       1/(365*15),
                 
                 omega=omega_,
                 psi  =psi_,    
                 mu=11.4/1000,
                 gamma=1/14,
                 rho=1/(365)
)
init=init.dcm(num.v06 =0,
              force.v06=0,
              num.s06 =1000,
              num.iv06=0,
              num.i06 =1,
              num.r06 =0,
              num.v1  =0,
              num.s1  =1000,
              num.iv1 =0,
              num.i1  =1,
              num.r1  =0,
              num.s5  =2000,
              num.iv5 =0,
              num.i5 =0,
              num.r5 =0,
              num.s10 =2000,
              num.iv10 =0,
              num.i10 =0,
              num.r10 =0,
              num.s30 =2000,
              num.iv30 =0,
              num.i30 =1,
              num.r30 =0,
              num.s40 =3000,
              num.iv40 =0,
              num.i40 =1,
              num.r40 =0,
              num.s60=3000,
              num.iv60=0,
              num.i60 =1,
              num.r60=0,
              
              incidence.06_vac  = 0,
              incidence.06      = 0,
              incidence.1_vac  = 0,
              incidence.1      = 0,
              incidence.5      = 0,
              incidence.10      =0,
              incidence.30      =0,
              incidence.40      =0,
              incidence.60      =0
              )
control=control.dcm(nstep=365*3,new.mod=RSV)
sim=dcm(params,init,control)
```

```{r}
sim=mutate_epi(sim,num = num.v06 + num.s06 + num.iv06 + num.i06 + num.r06 +
                         num.v1  + num.s1 +  num.iv1 +  num.i1 +  num.r1  + 
                         num.s5 +  num.iv5 +  num.i5 +  num.r5  +
                         num.s10 +  num.iv10 +  num.i10 +  num.r10  +
                         num.s30 +  num.iv30 +  num.i30 +  num.r30  +
                         num.s40 +  num.iv40 +  num.i40 +  num.r40  +
                         num.s60 +  num.iv60 +  num.i60 +  num.r60)
# hospitalization risk
# potential mechanism is vaccine reduce the rate of hospitalization. Although vaccine effect ends at 1 year old, the hospitalization rate among those who are older than 1 year is smaller than younger. This expects that vaccine prevent a the overall hospitalization rate/hospitalization averted.

hosp06v = 0.05
hosp06  = 0.1
hosp1v =  0.05
hosp1  =  0.1
hosp5  = 0.01
hosp10  = 0.01
hosp30  = 0.01
hosp40  = 0.01
hosp60  = 0.1

sim=mutate_epi(sim,
              hosp_incidence06 = incidence.06_vac*hosp06v + incidence.06*hosp06, 
              hosp_incidence1  = incidence.1_vac*hosp1v + incidence.1*hosp1,
              hosp_incidence5  = incidence.5 * hosp5,
              hosp_incidence10  = incidence.10 * hosp10,
              hosp_incidence30  = incidence.30 * hosp30,
              hosp_incidence40  = incidence.40 * hosp40,
              hosp_incidence60  = incidence.60 * hosp60)

df=data.frame(sim)
```

```{r}
head(df)
```

```{r}
df %>% ggplot(aes(x=time))+
    geom_line(aes(y=i ,color='infection 0-6m'))+
    geom_line(aes(y=num.i1,color='infection 6m-12m'))+
    geom_line(aes(y=num.i5,color='infection  1y-5y'))+
    geom_line(aes(y=num.i10,color='infection 5y-19y'))+
    geom_line(aes(y=num.i30,color='infection 20y-39y'))+
    geom_line(aes(y=num.i40,color='infection 40y-59y')) + 
    geom_line(aes(y=num.i60,color='infection 60y+'))
```

```{r}
# hospitalization
df %>% ggplot(aes(x=time))+
    geom_line(aes(y=hosp_incidence06,color='infection 0-6m'))+
    geom_line(aes(y=hosp_incidence1,color='infection 6m-2y'))+
    geom_line(aes(y=hosp_incidence5,color='infection 2y-19y'))+
    geom_line(aes(y=hosp_incidence10,color='infection 20y-39y'))+
    geom_line(aes(y=hosp_incidence30,color='infection 40y-59y'))+
    geom_line(aes(y=hosp_incidence40,color='infection 60y+'))+
    geom_line(aes(y=hosp_incidence60,color='infection 60y+'))
```

